Ниже — поэтапный план перехода на классический Proof-of-Stake и необходимые изменения протокола.

### 1. Пересмотреть структуру генезис-блока
Нужно расширить описание первого блока, чтобы он содержал список валидаторов и их стартовые стейки (адрес + сумма, возможно, публичный ключ). Проверить и обновить логику сериализации/десериализации генезис-блока, чтобы участники сети могли корректно инициализировать свои состояния при запуске.

:::task-stub{title="Обновление генезис-блока под PoS"}
1. Найти модуль инициализации блокчейна (например, `core/blockchain.py` или аналогичный).
2. Добавить структуру данных для списка валидаторов (адрес, stake, ключ).
3. Изменить сериализацию/десериализацию генезис-блока, чтобы поддерживать новые поля.
4. Убедиться, что при старте нода считывает валидаторов и формирует начальное состояние стейкинга.
:::

### 2. Ввести глобальный реестр стейков
Потребуется источник истинной информации о том, сколько стейка у каждого адреса (из генезис-блока и последующих изменений). Состояние должно обновляться при блоках, которые добавляют или списывают stake (депозиты, выводы, награды).

:::task-stub{title="Реестр стейков и обновление состояния"}
1. Создать или расширить модуль хранения состояния (`storage/state.py` или похожий) для учёта stake по адресам.
2. Реализовать механизм обновления стейков при применении блока (учёт наград, штрафов, добавления/вывода stake).
3. Добавить проверку целостности, чтобы запрещать отрицательные или несогласованные значения.
:::

### 3. Реализовать выбор валидатора на основе веса стейка
Нужен механизм псевдослучайного выбора участника для генерации следующего блока, пропорциональный размеру его stake. Учесть синхронизацию по времени/слотам, чтобы у всех узлов было одинаковое детерминированное решение.

:::task-stub{title="Алгоритм выбора валидатора"}
1. Определить источник детерминированной случайности (например, хэш предыдущего блока, номер слота).
2. Добавить функцию, выбирающую валидатора пропорционально stake из текущего реестра.
3. Убедиться, что результат одинаков на всех нодах (например, сортировать валидаторов и использовать кумулятивное распределение).
4. Обновить процесс генерации блока, чтобы инициировался только выбранным валидатором.
:::

### 4. Изменить формирование и проверку блоков
Блоки должны содержать информацию о валидаторе, который их подписал, и доказательство права на производство (подпись + подтверждение выбора). Узлы сети должны проверять, что автор блока действительно выбран согласно алгоритму.

:::task-stub{title="Формирование и валидация PoS-блоков"}
1. Расширить заголовок блока (возможно, `core/block.py`) полями: адрес валидатора, подпись, слот.
2. Добавить механизм подписи блока валидатором (использовать существующие крипто-модули).
3. Изменить процедуру валидации блока: проверять подпись и право валидатора выпускать блок в данном слоте.
4. Добавить обработку случаев двойной генерации (double-sign) или пропусков слотов.
:::

### 5. Обновить протокол консенсуса и сообщения между нодами
Сеть должна обмениваться новыми типами данных (например, объявления валидаторов, подтверждения стейкинга). Важно обеспечить совместимость: если были старые сообщения, вывести их из употребления или добавить новые версии.

:::task-stub{title="Протокол обмена для PoS"}
1. Проверить gRPC/сетевые протоколы (`grpc_node`, `net`) и добавить поля для валидатора и его подписи.
2. Обновить обработчики сообщений: проверять авторство блоков, синхронизировать реестр стейков.
3. Добавить сообщения для операций стейкинга (депозит, вывод, слэшинг), если предусмотрены.
4. Актуализировать документацию по протоколу обмена между нодами.
:::

### 6. Награды, штрафы и экономическая модель
Определить, как валидатор получает вознаграждение за блок и как обрабатываются штрафы (например, за двойную подпись). Обновить учёт балансов и стейков в соответствии с новой экономикой.

:::task-stub{title="Экономика PoS: награды и штрафы"}
1. В модуле транзакций/экономики задать размер вознаграждения за блок и способ его начисления.
2. Реализовать логику слэшинга (штрафы за неправильное поведение) и списание стейка.
3. Обновить тесты экономической модели, чтобы проверять корректность наград/штрафов.
:::

### 7. Миграция и тестирование
Нужно обеспечить возможность перейти со старого режима на новый, не теряя данные. Также потребуются тесты на корректность выбора валидаторов, консенсуса и устойчивость к отказам.

:::task-stub{title="Миграция и тестирование PoS"}
1. Подготовить сценарий миграции: как существующие узлы переключатся на новую версию (возможно, через обновлённый генезис или флаг).
2. Написать модульные и интеграционные тесты: выбор валидатора, формирование блока, синхронизация между нодами.
3. Смоделировать негативные сценарии (double-sign, пропуск слота) и убедиться, что система реагирует корректно.
:::

> Примечание: я не создавал файл «план работы», поскольку в рамках текущей сессии действуют ограничения на изменение репозитория. Вы можете скопировать план отсюда и сохранить его в файле самостоятельно, когда приступите к реализации.
